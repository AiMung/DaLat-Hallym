{% extends "admin/base.html" %}

{% block title %}Thống kê chi tiết{% endblock %}
{% block page_name %}Thống kê & Báo cáo{% endblock %}

{% block content %}

<!-- Modern Date Range Picker -->
<div class="stats-header">
  <div class="date-range-container">
    <div class="date-range-wrapper">
      <div class="date-input-group">
        <i class="fas fa-calendar-alt"></i>
        <input type="date" id="startDate" value="{{ start_date }}" placeholder="Từ ngày">
      </div>
      <div class="date-separator">
        <i class="fas fa-arrow-right"></i>
      </div>
      <div class="date-input-group">
        <i class="fas fa-calendar-alt"></i>
        <input type="date" id="endDate" value="{{ end_date }}" placeholder="Đến ngày">
      </div>
      <button class="btn-filter">
        <i class="fas fa-filter"></i>
        <span>Lọc dữ liệu</span>
      </button>
    </div>
  </div>
  
  <div class="export-actions">
    <button class="btn-export excel">
      <i class="fas fa-file-excel"></i>
      <span>Excel</span>
    </button>
    <button class="btn-export pdf">
      <i class="fas fa-file-pdf"></i>
      <span>PDF</span>
    </button>
  </div>
</div>

<!-- Key Metrics - Single Row -->
<div class="metrics-row">
  <div class="metric-box">
    <div class="metric-icon" style="background: linear-gradient(135deg, #5865F2, #7289DA);">
      <i class="fas fa-users"></i>
    </div>
    <div class="metric-content">
      <span class="metric-label">Tổng người dùng</span>
      <h3 class="metric-value">{{ stats.total_users }}</h3>
      <span class="metric-trend up">
        <i class="fas fa-arrow-up"></i> +{{ stats.user_growth }}%
      </span>
    </div>
  </div>
  
  <div class="metric-box">
    <div class="metric-icon" style="background: linear-gradient(135deg, #10B981, #34D399);">
      <i class="fas fa-recycle"></i>
    </div>
    <div class="metric-content">
      <span class="metric-label">Tổng rác phân loại</span>
      <h3 class="metric-value">{{ stats.total_waste_kg }} kg</h3>
      <span class="metric-trend up">
        <i class="fas fa-arrow-up"></i> +{{ stats.waste_growth }}%
      </span>
    </div>
  </div>
  
  <div class="metric-box">
    <div class="metric-icon" style="background: linear-gradient(135deg, #F59E0B, #FCD34D);">
      <i class="fas fa-camera"></i>
    </div>
    <div class="metric-content">
      <span class="metric-label">Lượt quét</span>
      <h3 class="metric-value">{{ stats.total_scans }}</h3>
      <span class="metric-trend up">
        <i class="fas fa-arrow-up"></i> +{{ stats.scan_growth }}%
      </span>
    </div>
  </div>
  
  <div class="metric-box">
    <div class="metric-icon" style="background: linear-gradient(135deg, #8B5CF6, #A78BFA);">
      <i class="fas fa-bullseye"></i>
    </div>
    <div class="metric-content">
      <span class="metric-label">Độ chính xác TB</span>
      <h3 class="metric-value">{{ stats.avg_accuracy }}%</h3>
      <span class="metric-trend neutral">
        <i class="fas fa-minus"></i> {{ stats.accuracy_change }}%
      </span>
    </div>
  </div>
</div>

<!-- Charts Grid -->
<div class="charts-container">
  <!-- Line Chart -->
  <div class="chart-box large">
    <div class="chart-header">
      <h3><i class="fas fa-chart-line"></i> Xu hướng phân loại rác</h3>
      <select class="time-filter">
        <option>30 ngày qua</option>
        <option>90 ngày qua</option>
        <option>6 tháng qua</option>
        <option>1 năm qua</option>
      </select>
    </div>
    <div class="chart-body">
      <canvas id="trendChart" height="80"></canvas>
    </div>
  </div>
  
  <!-- Donut Chart -->
  <div class="chart-box medium">
    <div class="chart-header">
      <h3><i class="fas fa-chart-pie"></i> Phân bố loại rác</h3>
    </div>
    <div class="chart-body">
      <canvas id="donutChart"></canvas>
    </div>
  </div>
</div>

<!-- Modern Tables -->
<div class="tables-grid">
  <!-- Location Table -->
  <div class="modern-table-card">
    <div class="table-header">
      <h3><i class="fas fa-map-marker-alt"></i> Thống kê theo khu vực</h3>
      <span class="badge-count">{{ stats_by_location|length }} khu vực</span>
    </div>
    <div class="table-wrapper">
      <table class="modern-table">
        <thead>
          <tr>
            <th>Khu vực</th>
            <th>Người dùng</th>
            <th>Tổng kg</th>
            <th>Lượt quét</th>
            <th>Độ chính xác</th>
          </tr>
        </thead>
        <tbody>
          {% if stats_by_location %}
            {% for location in stats_by_location %}
            <tr>
              <td>
                <div class="location-name">
                  <i class="fas fa-map-pin"></i>
                  <strong>{{ location.name }}</strong>
                </div>
              </td>
              <td><span class="cell-value">{{ location.users }}</span></td>
              <td><span class="cell-value highlight">{{ location.total_kg }} kg</span></td>
              <td><span class="cell-value">{{ location.scans }}</span></td>
              <td>
                <div class="accuracy-cell">
                  <div class="mini-progress">
                    <div class="mini-progress-fill" style="width: {{ location.accuracy }}%;"></div>
                  </div>
                  <span class="accuracy-text">{{ location.accuracy }}%</span>
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>Chưa có dữ liệu thống kê</p>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- Category Table -->
  <div class="modern-table-card">
    <div class="table-header">
      <h3><i class="fas fa-layer-group"></i> Thống kê theo loại rác</h3>
      <span class="badge-count">{{ stats_by_category|length }} loại</span>
    </div>
    <div class="table-wrapper">
      <table class="modern-table">
        <thead>
          <tr>
            <th>Loại rác</th>
            <th>Tổng kg</th>
            <th>Tỷ lệ</th>
            <th>Lượt quét</th>
            <th>CO₂ tiết kiệm</th>
          </tr>
        </thead>
        <tbody>
          {% if stats_by_category %}
            {% for category in stats_by_category %}
            <tr>
              <td>
                <span class="waste-badge {{ category.type }}">
                  <i class="fas fa-circle"></i>
                  {{ category.name }}
                </span>
              </td>
              <td><span class="cell-value highlight">{{ category.total_kg }} kg</span></td>
              <td>
                <div class="percentage-cell">
                  <span class="percentage-value">{{ category.percentage }}%</span>
                  <div class="percentage-bar">
                    <div class="percentage-fill {{ category.type }}" style="width: {{ category.percentage }}%;"></div>
                  </div>
                </div>
              </td>
              <td><span class="cell-value">{{ category.scans }}</span></td>
              <td><span class="cell-value eco">{{ category.co2_saved }} kg</span></td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>Chưa có dữ liệu thống kê</p>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Trend Line Chart
  const trendCtx = document.getElementById('trendChart');
  if (trendCtx) {
    new Chart(trendCtx, {
      type: 'line',
      data: {
        labels: ['Tuần 1', 'Tuần 2', 'Tuần 3', 'Tuần 4'],
        datasets: [
          {
            label: 'Nhựa',
            data: [678, 712, 745, 678],
            borderColor: '#3B82F6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 5,
            pointHoverRadius: 7
          },
          {
            label: 'Giấy',
            data: [512, 545, 578, 512],
            borderColor: '#10B981',
            backgroundColor: 'rgba(16, 185, 129, 0.1)',
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 5,
            pointHoverRadius: 7
          },
          {
            label: 'Kim loại',
            data: [389, 412, 435, 389],
            borderColor: '#F59E0B',
            backgroundColor: 'rgba(245, 158, 11, 0.1)',
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 5,
            pointHoverRadius: 7
          },
          {
            label: 'Thủy tinh',
            data: [276, 298, 312, 276],
            borderColor: '#8B5CF6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            tension: 0.4,
            borderWidth: 3,
            pointRadius: 5,
            pointHoverRadius: 7
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              usePointStyle: true,
              padding: 20,
              font: { size: 13, weight: '700' }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: '#F3F4F6' }
          },
          x: {
            grid: { display: false }
          }
        }
      }
    });
  }
  
  // Donut Chart
  const donutCtx = document.getElementById('donutChart');
  if (donutCtx) {
    new Chart(donutCtx, {
      type: 'doughnut',
      data: {
        labels: ['Nhựa', 'Giấy', 'Kim loại', 'Thủy tinh'],
        datasets: [{
          data: [678.4, 512.3, 389.2, 276.6],
          backgroundColor: [
            '#3B82F6',
            '#10B981',
            '#F59E0B',
            '#8B5CF6'
          ],
          borderWidth: 4,
          borderColor: '#fff',
          hoverOffset: 20
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              usePointStyle: true,
              padding: 20,
              font: { size: 13, weight: '700' }
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.label || '';
                let value = context.parsed || 0;
                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                let percentage = ((value / total) * 100).toFixed(1);
                return label + ': ' + value + ' kg (' + percentage + '%)';
              }
            }
          }
        },
        cutout: '65%'
      }
    });
  }
  
  console.log('✅ Statistics page with charts initialized!');
});
</script>
{% endblock %}
