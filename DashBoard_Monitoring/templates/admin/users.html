{% extends "admin/base.html" %}

{% block title %}Qu·∫£n l√Ω ng∆∞·ªùi d√πng{% endblock %}
{% block page_name %}Ng∆∞·ªùi d√πng{% endblock %}

{% block content %}

<!-- ‚≠ê DATA GI·∫¢ - ƒê√É FIX FORMAT NG√ÄY ‚≠ê -->
{% set fake_users = [
  {'id': 1, 'name': 'Nguy·ªÖn VƒÉn An', 'email': 'nguyenvanan@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/men/32.jpg', 'points': 2450, 'total_kg': 45.8, 'rank': 1, 'is_active': True, 'is_vip': True, 'created_at': '15/01/2024'},
  {'id': 2, 'name': 'Tr·∫ßn Th·ªã B·∫£o', 'email': 'tranthibao@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/women/44.jpg', 'points': 2180, 'total_kg': 42.3, 'rank': 2, 'is_active': True, 'is_vip': True, 'created_at': '20/01/2024'},
  {'id': 3, 'name': 'L√™ Minh Chi·∫øn', 'email': 'leminhchien@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/men/54.jpg', 'points': 1890, 'total_kg': 38.9, 'rank': 3, 'is_active': True, 'is_vip': False, 'created_at': '05/02/2024'},
  {'id': 4, 'name': 'Ph·∫°m Thu Duy√™n', 'email': 'phamthuduyen@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/women/68.jpg', 'points': 1654, 'total_kg': 35.2, 'rank': 4, 'is_active': True, 'is_vip': False, 'created_at': '12/02/2024'},
  {'id': 5, 'name': 'Ho√†ng Minh Em', 'email': 'hoangminhem@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/men/75.jpg', 'points': 1523, 'total_kg': 32.7, 'rank': 5, 'is_active': True, 'is_vip': False, 'created_at': '18/02/2024'},
  {'id': 6, 'name': 'V≈© Th·ªã Ph∆∞∆°ng', 'email': 'vuthiphuong@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/women/28.jpg', 'points': 1420, 'total_kg': 29.4, 'rank': 6, 'is_active': True, 'is_vip': False, 'created_at': '01/03/2024'},
  {'id': 7, 'name': 'ƒê·ªó VƒÉn Gia', 'email': 'dovangia@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/men/62.jpg', 'points': 1298, 'total_kg': 27.8, 'rank': 7, 'is_active': True, 'is_vip': False, 'created_at': '08/03/2024'},
  {'id': 8, 'name': 'Ng√¥ Thu H√†', 'email': 'ngothuha@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/women/52.jpg', 'points': 1156, 'total_kg': 25.1, 'rank': 8, 'is_active': False, 'is_vip': False, 'created_at': '15/03/2024'},
  {'id': 9, 'name': 'B√πi VƒÉn Inh', 'email': 'buivaninh@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/men/45.jpg', 'points': 1089, 'total_kg': 23.6, 'rank': 9, 'is_active': True, 'is_vip': False, 'created_at': '22/03/2024'},
  {'id': 10, 'name': 'L√Ω Th·ªã Kh√°nh', 'email': 'lythikhanh@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/women/65.jpg', 'points': 945, 'total_kg': 21.3, 'rank': 10, 'is_active': True, 'is_vip': False, 'created_at': '01/04/2024'},
  {'id': 11, 'name': 'Tr·ªãnh VƒÉn Long', 'email': 'trinhvanlong@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/men/88.jpg', 'points': 892, 'total_kg': 19.7, 'rank': 11, 'is_active': True, 'is_vip': False, 'created_at': '08/04/2024'},
  {'id': 12, 'name': 'ƒêinh Th·ªã Mai', 'email': 'dinhthimai@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/women/38.jpg', 'points': 834, 'total_kg': 18.2, 'rank': 12, 'is_active': False, 'is_vip': False, 'created_at': '15/04/2024'},
  {'id': 13, 'name': 'Phan VƒÉn Nam', 'email': 'phanvannam@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/men/72.jpg', 'points': 756, 'total_kg': 16.8, 'rank': 13, 'is_active': True, 'is_vip': False, 'created_at': '22/04/2024'},
  {'id': 14, 'name': 'H·ªì Th·ªã Oanh', 'email': 'hothioanh@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/women/82.jpg', 'points': 698, 'total_kg': 15.4, 'rank': 14, 'is_active': True, 'is_vip': False, 'created_at': '01/05/2024'},
  {'id': 15, 'name': 'V√µ VƒÉn Phong', 'email': 'vovanphong@gmail.com', 'avatar': 'https://randomuser.me/api/portraits/men/58.jpg', 'points': 623, 'total_kg': 14.1, 'rank': 15, 'is_active': False, 'is_vip': False, 'created_at': '08/05/2024'}
] %}

{% set users = fake_users %}

<!-- ============================================
     PAGE HEADER
     ============================================ -->
<div class="page-header">
  <div>
    <h1>üë• Qu·∫£n l√Ω ng∆∞·ªùi d√πng</h1>
    <p class="subtitle">Qu·∫£n l√Ω v√† theo d√µi ho·∫°t ƒë·ªông c·ªßa {{ users|length }} ng∆∞·ªùi d√πng trong h·ªá th·ªëng</p>
  </div>
  <div class="header-actions">
    <button class="btn-export" onclick="exportUsers()">
      <i class="fas fa-download"></i> Xu·∫•t Excel
    </button>
    <button class="btn-primary" onclick="openAddUserModal()">
      <i class="fas fa-user-plus"></i> Th√™m ng∆∞·ªùi d√πng
    </button>
  </div>
</div>

<!-- ============================================
     STATS CARDS - QUICK OVERVIEW
     ============================================ -->
<div class="users-stats-grid">
  <div class="stat-card-mini">
    <div class="stat-mini-icon" style="background: linear-gradient(135deg, #5865F2, #7289DA);">
      <i class="fas fa-users"></i>
    </div>
    <div class="stat-mini-content">
      <h3>{{ users|length }}</h3>
      <p>T·ªïng ng∆∞·ªùi d√πng</p>
      <span class="stat-mini-change positive">
        <i class="fas fa-arrow-up"></i> +12.5%
      </span>
    </div>
  </div>

  <div class="stat-card-mini">
    <div class="stat-mini-icon" style="background: linear-gradient(135deg, #10B981, #34D399);">
      <i class="fas fa-user-check"></i>
    </div>
    <div class="stat-mini-content">
      <h3>{{ users|selectattr('is_active')|list|length }}</h3>
      <p>ƒêang ho·∫°t ƒë·ªông</p>
      <span class="stat-mini-change positive">
        <i class="fas fa-arrow-up"></i> +8.2%
      </span>
    </div>
  </div>

  <div class="stat-card-mini">
    <div class="stat-mini-icon" style="background: linear-gradient(135deg, #F59E0B, #FCD34D);">
      <i class="fas fa-crown"></i>
    </div>
    <div class="stat-mini-content">
      <h3>{{ users|selectattr('is_vip')|list|length }}</h3>
      <p>Th√†nh vi√™n VIP</p>
      <span class="stat-mini-change neutral">
        <i class="fas fa-minus"></i> 0%
      </span>
    </div>
  </div>

  <div class="stat-card-mini">
    <div class="stat-mini-icon" style="background: linear-gradient(135deg, #8B5CF6, #A78BFA);">
      <i class="fas fa-user-plus"></i>
    </div>
    <div class="stat-mini-content">
      <h3>24</h3>
      <p>M·ªõi trong tu·∫ßn</p>
      <span class="stat-mini-change positive">
        <i class="fas fa-arrow-up"></i> +15.3%
      </span>
    </div>
  </div>
</div>

<!-- ============================================
     FILTERS & SEARCH TOOLBAR
     ============================================ -->
<div class="users-toolbar">
  <div class="toolbar-left">
    <div class="search-box-modern">
      <i class="fas fa-search"></i>
      <input type="text" placeholder="T√¨m ki·∫øm theo t√™n, email, ID..." id="userSearch">
      <button class="search-clear" style="display: none;">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  
  <div class="toolbar-right">
    <select class="filter-select-modern" id="statusFilter">
      <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
      <option value="active">Ho·∫°t ƒë·ªông</option>
      <option value="inactive">Kh√¥ng ho·∫°t ƒë·ªông</option>
      <option value="vip">Th√†nh vi√™n VIP</option>
    </select>
    
    <select class="filter-select-modern" id="rankFilter">
      <option value="all">T·∫•t c·∫£ h·∫°ng</option>
      <option value="1-10">Top 10</option>
      <option value="11-50">Top 11-50</option>
      <option value="51+">51+</option>
    </select>

    <button class="btn-filter-toggle" onclick="toggleAdvancedFilters()">
      <i class="fas fa-sliders"></i> B·ªô l·ªçc
    </button>
  </div>
</div>

<!-- Advanced Filters (Collapsed by default) -->
<div class="advanced-filters" id="advancedFilters" style="display: none;">
  <div class="filter-row">
    <div class="filter-group">
      <label>ƒêi·ªÉm t·ª´</label>
      <input type="number" placeholder="0" class="filter-input">
    </div>
    <div class="filter-group">
      <label>ƒêi·ªÉm ƒë·∫øn</label>
      <input type="number" placeholder="10000" class="filter-input">
    </div>
    <div class="filter-group">
      <label>Ng√†y tham gia</label>
      <input type="date" class="filter-input">
    </div>
    <div class="filter-group">
      <button class="btn-apply-filters">
        <i class="fas fa-check"></i> √Åp d·ª•ng
      </button>
      <button class="btn-reset-filters">
        <i class="fas fa-rotate"></i> ƒê·∫∑t l·∫°i
      </button>
    </div>
  </div>
</div>

<!-- ============================================
     USERS TABLE
     ============================================ -->
<div class="users-table-card">
  <div class="table-header">
    <div class="table-header-left">
      <input type="checkbox" id="selectAll" class="checkbox-modern">
      <span class="selected-count" style="display: none;">
        <strong id="selectedCount">0</strong> ƒë∆∞·ª£c ch·ªçn
      </span>
      <button class="btn-bulk-action" style="display: none;">
        <i class="fas fa-trash"></i> X√≥a
      </button>
    </div>
    <div class="table-header-right">
      <span class="table-info">
        Hi·ªÉn th·ªã <strong>{{ users|length }}</strong> ng∆∞·ªùi d√πng
      </span>
    </div>
  </div>

  <div class="table-responsive">
    <table class="modern-table">
      <thead>
        <tr>
          <th width="40">
            <input type="checkbox" id="selectAllHeader" class="checkbox-modern">
          </th>
          <th>Ng∆∞·ªùi d√πng</th>
          <th>Email</th>
          <th class="text-center">
            <i class="fas fa-coins" style="color: #F59E0B;"></i> ƒêi·ªÉm
          </th>
          <th class="text-center">
            <i class="fas fa-weight-hanging" style="color: #10B981;"></i> T·ªïng kg
          </th>
          <th class="text-center">
            <i class="fas fa-trophy" style="color: #EF4444;"></i> H·∫°ng
          </th>
          <th class="text-center">Tr·∫°ng th√°i</th>
          <th>Ng√†y tham gia</th>
          <th width="120" class="text-center">H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr class="user-row" data-user-id="{{ user.id }}">
          <td>
            <input type="checkbox" class="checkbox-modern user-checkbox" value="{{ user.id }}">
          </td>
          <td>
            <div class="user-cell-modern">
              <div class="user-avatar">
                <img src="{{ user.avatar }}" alt="{{ user.name }}">
                {% if user.is_vip %}
                <span class="vip-badge-tiny">
                  <i class="fas fa-crown"></i>
                </span>
                {% endif %}
              </div>
              <div class="user-info">
                <strong class="user-name">{{ user.name }}</strong>
                <span class="user-id-tag">ID: {{ user.id }}</span>
              </div>
            </div>
          </td>
          <td>
            <span class="email-text">{{ user.email }}</span>
          </td>
          <td class="text-center">
            <span class="points-badge">
              {{ user.points }}
            </span>
          </td>
          <td class="text-center">
            <span class="kg-badge">
              {{ user.total_kg }} kg
            </span>
          </td>
          <td class="text-center">
            <span class="rank-badge rank-{{ 'gold' if user.rank <= 3 else ('silver' if user.rank <= 10 else 'bronze') }}">
              #{{ user.rank }}
            </span>
          </td>
          <td class="text-center">
            <span class="status-badge-modern {{ 'status-active' if user.is_active else 'status-inactive' }}">
              <i class="fas fa-circle"></i>
              {{ 'Ho·∫°t ƒë·ªông' if user.is_active else 'Kh√¥ng ho·∫°t ƒë·ªông' }}
            </span>
          </td>
          <td>
            <div class="date-cell">
              <i class="fas fa-calendar-alt"></i>
              {{ user.created_at }}
            </div>
          </td>
          <td>
            <div class="action-buttons-modern">
              <button class="btn-action btn-view" 
                      data-user-id="{{ user.id }}" 
                      onclick="viewUser(this)" 
                      title="Xem chi ti·∫øt">
                <i class="fas fa-eye"></i>
              </button>
              <button class="btn-action btn-edit" 
                      data-user-id="{{ user.id }}" 
                      onclick="editUser(this)" 
                      title="Ch·ªânh s·ª≠a">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn-action btn-delete" 
                      data-user-id="{{ user.id }}" 
                      onclick="deleteUser(this)" 
                      title="X√≥a">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="9" class="no-data">
            <div class="empty-state">
              <i class="fas fa-users-slash"></i>
              <h3>Kh√¥ng c√≥ ng∆∞·ªùi d√πng n√†o</h3>
              <p>H√£y th√™m ng∆∞·ªùi d√πng ƒë·∫ßu ti√™n c·ªßa b·∫°n!</p>
              <button class="btn-primary" onclick="openAddUserModal()">
                <i class="fas fa-user-plus"></i> Th√™m ng∆∞·ªùi d√πng
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="table-pagination">
    <div class="pagination-info">
      Hi·ªÉn th·ªã <strong>1-{{ users|length }}</strong> trong t·ªïng s·ªë <strong>{{ users|length }}</strong>
    </div>
    <div class="pagination-controls">
      <button class="btn-pagination" disabled>
        <i class="fas fa-chevron-left"></i>
      </button>
      <button class="btn-pagination active">1</button>
      <button class="btn-pagination">2</button>
      <button class="btn-pagination">3</button>
      <button class="btn-pagination">
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Search functionality
document.getElementById('userSearch').addEventListener('input', function(e) {
  const searchTerm = e.target.value.toLowerCase();
  const rows = document.querySelectorAll('.user-row');
  
  rows.forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(searchTerm) ? '' : 'none';
  });
  
  document.querySelector('.search-clear').style.display = searchTerm ? 'block' : 'none';
});

// Clear search
document.querySelector('.search-clear').addEventListener('click', function() {
  document.getElementById('userSearch').value = '';
  document.querySelectorAll('.user-row').forEach(row => row.style.display = '');
  this.style.display = 'none';
});

// Select all checkboxes
document.getElementById('selectAll').addEventListener('change', function() {
  const checkboxes = document.querySelectorAll('.user-checkbox');
  checkboxes.forEach(cb => cb.checked = this.checked);
  updateBulkActions();
});

// Update bulk actions visibility
function updateBulkActions() {
  const checked = document.querySelectorAll('.user-checkbox:checked').length;
  document.getElementById('selectedCount').textContent = checked;
  document.querySelector('.selected-count').style.display = checked > 0 ? 'inline' : 'none';
  document.querySelector('.btn-bulk-action').style.display = checked > 0 ? 'inline-flex' : 'none';
}

document.querySelectorAll('.user-checkbox').forEach(cb => {
  cb.addEventListener('change', updateBulkActions);
});

// Toggle advanced filters
function toggleAdvancedFilters() {
  const filters = document.getElementById('advancedFilters');
  filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

// ‚≠ê S·ª¨A L·∫†I - D√ôNG DATA ATTRIBUTES
function viewUser(button) {
  const userId = button.getAttribute('data-user-id');
  window.location.href = `/admin/users/${userId}`;
}

function editUser(button) {
  const userId = button.getAttribute('data-user-id');
  alert(`Ch·ªânh s·ª≠a ng∆∞·ªùi d√πng #${userId}`);
}

function deleteUser(button) {
  const userId = button.getAttribute('data-user-id');
  if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?')) {
    alert(`ƒê√£ x√≥a ng∆∞·ªùi d√πng #${userId}`);
  }
}

function exportUsers() {
  alert('ƒêang xu·∫•t danh s√°ch ng∆∞·ªùi d√πng...');
}

function openAddUserModal() {
  alert('M·ªü form th√™m ng∆∞·ªùi d√πng');
}

console.log('‚úÖ Users management page initialized!');
</script>
{% endblock %}
